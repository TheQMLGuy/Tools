<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Armed Bandit - ML Visualizer</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../styles/shared.css">
    <style>
        .app-container {
            display: grid;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            overflow: hidden;
        }

        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
        }

        .app-title {
            font-size: 1.2rem;
            font-weight: 600;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-right {
            display: flex;
            gap: 8px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr 1fr 260px;
            gap: 12px;
            padding: 12px;
            overflow: hidden;
        }

        .panel {
            display: flex;
            flex-direction: column;
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.2);
        }

        .panel-header h2 {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .panel-body {
            flex: 1;
            overflow: auto;
            padding: 12px;
        }

        .panel-footer {
            padding: 10px 14px;
            border-top: 1px solid var(--border-color);
        }

        .bandit-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .bandit-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .bandit-emoji {
            font-size: 1.5rem;
        }

        .bandit-info {
            flex: 1;
        }

        .bandit-name {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .bandit-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-top: 4px;
        }

        .bandit-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        .bandit-count {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        .bandit-row.selected {
            border: 2px solid var(--accent-primary);
        }

        .calc-steps {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .calc-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-muted);
            text-align: center;
        }

        .calc-step {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            animation: fadeIn 0.3s;
        }

        .calc-step.active {
            border-color: var(--accent-primary);
        }

        .calc-step.completed {
            opacity: 0.7;
        }

        .calc-step-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .calc-step-number {
            width: 24px;
            height: 24px;
            background: var(--accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: white;
        }

        .calc-step-title {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .calc-step-content {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .calc-equation {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 10px;
            margin: 8px 0;
            font-family: var(--font-mono);
            text-align: center;
            font-size: 0.8rem;
        }

        .calc-result {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 6px;
            margin-top: 8px;
        }

        .calc-result-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .calc-result-value {
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--success);
        }

        .feature-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .feature-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }

        .feature-card.best {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .feature-name {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .feature-value {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .viz-panel .panel-body {
            padding: 0;
        }

        .viz-panel canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .param-section {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 12px;
            margin-bottom: 12px;
        }

        .param-section:last-child {
            border-bottom: none;
        }

        .param-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .param-item {
            margin-bottom: 12px;
        }

        .param-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.75rem;
        }

        .param-name code {
            font-family: var(--font-mono);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .param-value {
            font-family: var(--font-mono);
            color: var(--accent-primary);
        }

        .taming-list {
            list-style: none;
            padding: 0;
        }

        .taming-list li {
            font-size: 0.7rem;
            color: var(--text-muted);
            padding: 3px 0 3px 14px;
            position: relative;
        }

        .taming-list li::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: var(--success);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <h1 class="app-title">üé∞ Multi-Armed Bandit</h1>
            <div class="header-right">
                <button id="step-btn" class="btn btn-secondary">‚è≠ Step</button>
                <button id="auto-btn" class="btn btn-primary">‚ñ∂ Auto Run</button>
                <button id="reset-btn" class="btn btn-ghost">‚Üª Reset</button>
            </div>
        </header>
        <main class="main-content">
            <section class="panel">
                <div class="panel-header">
                    <h2>üé∞ Bandit Arms</h2>
                </div>
                <div class="panel-body">
                    <div id="bandit-stats" class="bandit-stats"></div>
                </div>
                <div class="panel-footer" style="font-size:0.7rem;color:var(--text-muted)">
                    True probs hidden - agent must explore!
                </div>
            </section>
            <section class="panel">
                <div class="panel-header">
                    <h2>üìê Selection Strategy</h2>
                    <span style="font-size:0.75rem;color:var(--text-muted)">Round <span
                            id="current-step">0</span></span>
                </div>
                <div class="panel-body">
                    <div id="calc-steps" class="calc-steps">
                        <div class="calc-placeholder">
                            <p>Click <strong>Step</strong> to pull arms</p>
                        </div>
                    </div>
                </div>
            </section>
            <section class="panel viz-panel">
                <div class="panel-header">
                    <h2>üé® Regret Over Time</h2>
                </div>
                <div class="panel-body"><canvas id="viz-canvas"></canvas></div>
                <div class="panel-footer" style="font-size:0.75rem;text-align:center">
                    Total Reward: <strong id="viz-reward">0</strong> | Regret: <strong id="viz-regret">0</strong>
                </div>
            </section>
            <section class="panel">
                <div class="panel-header">
                    <h2>‚öôÔ∏è Strategy</h2>
                </div>
                <div class="panel-body">
                    <div class="param-section">
                        <div class="param-section-title">Algorithm</div>
                        <select id="strategy-select" class="select" style="width:100%;margin-bottom:10px">
                            <option value="epsilon">Œµ-Greedy</option>
                            <option value="ucb">UCB</option>
                        </select>
                        <div class="param-item">
                            <div class="param-header"><span class="param-name"><code>Œµ / c</code></span><span
                                    class="param-value" id="param-value">0.1</span></div>
                            <input type="range" id="param-slider" class="slider" min="0.05" max="0.5" step="0.05"
                                value="0.1" style="width:100%">
                        </div>
                    </div>
                    <div class="param-section">
                        <div class="param-section-title">üí° Explore vs Exploit</div>
                        <ul class="taming-list">
                            <li><b>Œµ-Greedy:</b> Random with prob Œµ</li>
                            <li><b>UCB:</b> Bonus for uncertainty</li>
                            <li>Regret = optimal - actual reward</li>
                        </ul>
                    </div>
                </div>
                <div class="panel-footer">
                    <button id="apply-btn" class="btn btn-primary btn-block">Reset</button>
                </div>
            </section>
        </main>
    </div>
    <script>
        const ARMS = [
            { name: 'Arm 1', emoji: 'üçí', trueProb: 0.3, color: '#ef4444' },
            { name: 'Arm 2', emoji: 'üçã', trueProb: 0.5, color: '#f59e0b' },
            { name: 'Arm 3', emoji: 'üçá', trueProb: 0.7, color: '#8b5cf6' },
            { name: 'Arm 4', emoji: 'üçÄ', trueProb: 0.4, color: '#10b981' }
        ];

        let params = { epsilon: 0.1, strategy: 'epsilon' };
        let counts = [], rewards = [], estimates = [];
        let totalReward = 0, regretHistory = [];
        let steps = [], currentStep = 0;
        let isAutoRunning = false, autoInterval = null;

        function initBandits() {
            counts = ARMS.map(() => 0);
            rewards = ARMS.map(() => 0);
            estimates = ARMS.map(() => 0);
            totalReward = 0;
            regretHistory = [];
        }

        function ucbValue(i, t) {
            if (counts[i] === 0) return Infinity;
            return estimates[i] + params.epsilon * Math.sqrt(Math.log(t + 1) / counts[i]);
        }

        function selectArm(t) {
            if (params.strategy === 'epsilon') {
                if (Math.random() < params.epsilon) return Math.floor(Math.random() * ARMS.length);
                return estimates.indexOf(Math.max(...estimates));
            } else {
                const ucbs = estimates.map((_, i) => ucbValue(i, t));
                return ucbs.indexOf(Math.max(...ucbs));
            }
        }

        function pullArm(idx) {
            const reward = Math.random() < ARMS[idx].trueProb ? 1 : 0;
            counts[idx]++;
            rewards[idx] += reward;
            estimates[idx] = rewards[idx] / counts[idx];
            totalReward += reward;

            const optimalReward = Math.max(...ARMS.map(a => a.trueProb));
            const regret = (regretHistory.length > 0 ? regretHistory[regretHistory.length - 1] : 0) + (optimalReward - ARMS[idx].trueProb);
            regretHistory.push(regret);

            return reward;
        }

        function renderBanditStats(selectedIdx = -1) {
            const container = document.getElementById('bandit-stats');
            container.innerHTML = ARMS.map((arm, i) => `
                <div class="bandit-row ${selectedIdx === i ? 'selected' : ''}">
                    <span class="bandit-emoji">${arm.emoji}</span>
                    <div class="bandit-info">
                        <div class="bandit-name">${arm.name}</div>
                        <div class="bandit-bar">
                            <div class="bandit-bar-fill" style="width:${estimates[i] * 100}%;background:${arm.color}"></div>
                        </div>
                    </div>
                    <div class="bandit-count">${counts[i]}√ó<br>${estimates[i].toFixed(2)}</div>
                </div>
            `).join('');
        }

        function generateSteps() {
            steps = [];
            initBandits();

            steps.push({
                title: 'Problem Setup',
                content: `<p>${ARMS.length} slot machines with unknown probabilities</p>
                    <p style="margin-top:8px">Goal: Maximize total reward over time</p>
                    <div class="calc-equation">${params.strategy === 'epsilon' ? 'Œµ-Greedy: Explore with prob Œµ' : 'UCB: Q(a) + c‚àö(ln(t)/N(a))'}</div>`,
                selectedArm: -1
            });

            for (let t = 0; t < 30; t++) {
                const arm = selectArm(t);
                const reward = pullArm(arm);

                if (t < 5 || t % 5 === 0 || t === 29) {
                    steps.push({
                        title: `Round ${t + 1}: Pull ${ARMS[arm].emoji}`,
                        content: `<div class="feature-comparison">
                                ${ARMS.map((a, i) => `<div class="feature-card ${arm === i ? 'best' : ''}"><div class="feature-name">${a.emoji}</div><div class="feature-value">${estimates[i].toFixed(2)}</div></div>`).join('')}
                            </div>
                            <div class="calc-result"><span class="calc-result-label">Reward</span><span class="calc-result-value">${reward}</span></div>`,
                        selectedArm: arm
                    });
                }
            }
        }

        const canvas = document.getElementById('viz-canvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; render(); }

        function render() {
            const w = canvas.width, h = canvas.height;
            ctx.fillStyle = '#0a0a0f'; ctx.fillRect(0, 0, w, h);
            if (regretHistory.length < 2) return;

            const pad = 40;
            const maxR = Math.max(...regretHistory) * 1.2 || 1;
            const scaleX = i => pad + (i / (regretHistory.length - 1)) * (w - 2 * pad);
            const scaleY = r => h - pad - (r / maxR) * (h - 2 * pad);

            // Grid
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            for (let i = 0; i <= 5; i++) {
                const y = pad + (i / 5) * (h - 2 * pad);
                ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w - pad, y); ctx.stroke();
            }

            // Line
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 2;
            ctx.beginPath();
            regretHistory.forEach((r, i) => {
                if (i === 0) ctx.moveTo(scaleX(i), scaleY(r));
                else ctx.lineTo(scaleX(i), scaleY(r));
            });
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#606070';
            ctx.font = '10px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('Rounds', w / 2, h - 10);
            ctx.save();
            ctx.translate(12, h / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Cumulative Regret', 0, 0);
            ctx.restore();
        }

        function displayStep(step) {
            const container = document.getElementById('calc-steps');
            container.querySelectorAll('.calc-step').forEach(s => { s.classList.remove('active'); s.classList.add('completed'); });
            container.querySelector('.calc-placeholder')?.remove();

            const div = document.createElement('div');
            div.className = 'calc-step active';
            div.innerHTML = `<div class="calc-step-header"><span class="calc-step-number">${currentStep + 1}</span><span class="calc-step-title">${step.title}</span></div><div class="calc-step-content">${step.content}</div>`;
            container.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth', block: 'end' });

            renderBanditStats(step.selectedArm);
            render();
            document.getElementById('viz-reward').textContent = totalReward;
            document.getElementById('viz-regret').textContent = (regretHistory[regretHistory.length - 1] || 0).toFixed(2);
        }

        function step() { if (currentStep >= steps.length) { stopAuto(); return; } displayStep(steps[currentStep]); currentStep++; document.getElementById('current-step').textContent = currentStep; }
        function startAuto() { isAutoRunning = true; document.getElementById('auto-btn').textContent = '‚è∏ Pause'; autoInterval = setInterval(() => { if (currentStep >= steps.length) { stopAuto(); return; } step(); }, 500); }
        function stopAuto() { isAutoRunning = false; document.getElementById('auto-btn').textContent = '‚ñ∂ Auto Run'; if (autoInterval) clearInterval(autoInterval); }
        function reset() { stopAuto(); currentStep = 0; document.getElementById('current-step').textContent = 0; document.getElementById('calc-steps').innerHTML = '<div class="calc-placeholder"><p>Click <strong>Step</strong> to pull arms</p></div>'; initBandits(); generateSteps(); renderBanditStats(); render(); }

        document.getElementById('step-btn').addEventListener('click', step);
        document.getElementById('auto-btn').addEventListener('click', () => isAutoRunning ? stopAuto() : startAuto());
        document.getElementById('reset-btn').addEventListener('click', reset);
        document.getElementById('apply-btn').addEventListener('click', reset);
        document.getElementById('strategy-select').addEventListener('change', e => { params.strategy = e.target.value; reset(); });
        document.getElementById('param-slider').addEventListener('input', e => { params.epsilon = parseFloat(e.target.value); document.getElementById('param-value').textContent = params.epsilon; });

        window.addEventListener('resize', resizeCanvas);
        initBandits();
        renderBanditStats();
        resizeCanvas();
        generateSteps();
    </script>
</body>

</html>