<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decision Tree - ML Visualizer</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../styles/shared.css">
    <style>
        .app-container {
            display: grid;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            overflow: hidden;
        }

        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
        }

        .app-title {
            font-size: 1.2rem;
            font-weight: 600;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-right {
            display: flex;
            gap: 8px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr 1fr 260px;
            gap: 12px;
            padding: 12px;
            overflow: hidden;
        }

        .panel {
            display: flex;
            flex-direction: column;
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.2);
        }

        .panel-header h2 {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .panel-body {
            flex: 1;
            overflow: auto;
            padding: 12px;
        }

        .panel-footer {
            padding: 10px 14px;
            border-top: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.65rem;
        }

        .data-table th {
            background: var(--bg-secondary);
            padding: 5px;
            text-align: left;
            border-bottom: 2px solid var(--accent-primary);
        }

        .data-table td {
            padding: 4px 5px;
            border-bottom: 1px solid var(--border-color);
            font-family: var(--font-mono);
        }

        .data-table tr.highlight td {
            background: rgba(99, 102, 241, 0.2);
        }

        .data-table tr.yes td {
            background: rgba(16, 185, 129, 0.15);
        }

        .data-table tr.no td {
            background: rgba(239, 68, 68, 0.15);
        }

        .calc-steps {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .calc-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-muted);
            text-align: center;
        }

        .calc-step {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            animation: fadeIn 0.3s;
        }

        .calc-step.active {
            border-color: var(--accent-primary);
        }

        .calc-step.completed {
            opacity: 0.6;
        }

        .calc-step-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .calc-step-number {
            width: 22px;
            height: 22px;
            background: var(--accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
        }

        .calc-step-title {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .calc-step-content {
            font-size: 0.7rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .calc-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 8px;
            margin: 6px 0;
            font-family: var(--font-mono);
            font-size: 0.65rem;
            overflow-x: auto;
            line-height: 1.6;
        }

        .calc-result {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 6px;
            margin-top: 6px;
        }

        .calc-result-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .calc-result-value {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--success);
        }

        .viz-panel .panel-body {
            padding: 0;
        }

        .viz-panel canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .viz-stats {
            display: flex;
            gap: 16px;
            justify-content: center;
            font-size: 0.7rem;
        }

        .param-section {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .param-section:last-child {
            border-bottom: none;
        }

        .param-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .param-item {
            margin-bottom: 10px;
        }

        .param-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .param-name code {
            font-family: var(--font-mono);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .param-value {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--accent-primary);
        }

        .taming-list {
            list-style: none;
            padding: 0;
        }

        .taming-list li {
            font-size: 0.65rem;
            color: var(--text-muted);
            padding: 3px 0 3px 14px;
            position: relative;
        }

        .taming-list li::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: var(--success);
        }

        .btn-block {
            width: 100%;
            margin-top: 6px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <h1 class="app-title">üå≥ Decision Tree - Step by Step</h1>
            <div class="header-right">
                <button id="step-btn" class="btn btn-secondary">‚è≠ Step</button>
                <button id="auto-btn" class="btn btn-primary">‚ñ∂ Auto Run</button>
                <button id="reset-btn" class="btn btn-ghost">‚Üª Reset</button>
            </div>
        </header>
        <main class="main-content">
            <section class="panel">
                <div class="panel-header">
                    <h2>üìä Training Data</h2>
                </div>
                <div class="panel-body">
                    <table id="data-table" class="data-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="panel-footer" style="font-size:0.65rem;color:var(--text-muted)">
                    <span style="color:#10b981">Yes</span> = Play Tennis | <span style="color:#ef4444">No</span> = Don't
                    Play
                </div>
            </section>
            <section class="panel">
                <div class="panel-header">
                    <h2>üìê Full Gini Calculations</h2>
                    <span style="font-size:0.7rem;color:var(--text-muted)">Step <span id="current-step">0</span>/<span
                            id="total-steps">0</span></span>
                </div>
                <div class="panel-body">
                    <div id="calc-steps" class="calc-steps">
                        <div class="calc-placeholder">
                            <p>Click <strong>Step</strong> to see every Gini calculation</p>
                        </div>
                    </div>
                </div>
            </section>
            <section class="panel viz-panel">
                <div class="panel-header">
                    <h2>üé® Decision Tree</h2>
                </div>
                <div class="panel-body"><canvas id="viz-canvas"></canvas></div>
                <div class="panel-footer">
                    <div class="viz-stats">
                        <span>Nodes: <strong id="viz-nodes">0</strong></span>
                        <span>Depth: <strong id="viz-depth">0</strong></span>
                    </div>
                </div>
            </section>
            <section class="panel">
                <div class="panel-header">
                    <h2>‚öôÔ∏è Parameters</h2>
                </div>
                <div class="panel-body">
                    <div class="param-section">
                        <div class="param-item">
                            <div class="param-header">
                                <span class="param-name"><code>criterion</code></span>
                                <span class="param-value">gini</span>
                            </div>
                            <div style="font-size:0.65rem;color:var(--text-muted);margin-top:2px">Impurity measure</div>
                        </div>
                        <div class="param-item">
                            <div class="param-header">
                                <span class="param-name"><code>max_depth</code></span>
                                <span class="param-value" id="depth-value">3</span>
                            </div>
                            <input type="range" id="depth-slider" class="slider" min="1" max="4" value="3"
                                style="width:100%">
                        </div>
                    </div>
                    <div class="param-section">
                        <div class="param-section-title">üí° Gini Formula</div>
                        <div class="calc-box">Gini = 1 - Œ£(p·µ¢)¬≤</div>
                        <ul class="taming-list">
                            <li>p·µ¢ = fraction of class i</li>
                            <li>Gini = 0 means pure (one class)</li>
                            <li>Gini = 0.5 means max impurity (50/50)</li>
                        </ul>
                    </div>
                </div>
                <div class="panel-footer">
                    <button id="random-btn" class="btn btn-primary btn-block">üé≤ Random Data</button>
                    <button id="apply-btn" class="btn btn-secondary btn-block">Apply & Restart</button>
                </div>
            </section>
        </main>
    </div>
    <script>
        // Tennis dataset
        function generateData() {
            const outlooks = ['Sunny', 'Overcast', 'Rain'];
            const temps = ['Hot', 'Mild', 'Cool'];
            const humids = ['High', 'Normal'];
            const winds = ['Weak', 'Strong'];

            const data = [];
            for (let i = 0; i < 14; i++) {
                const outlook = outlooks[Math.floor(Math.random() * 3)];
                const temp = temps[Math.floor(Math.random() * 3)];
                const humidity = humids[Math.floor(Math.random() * 2)];
                const wind = winds[Math.floor(Math.random() * 2)];

                // Simple rules for play decision
                let play;
                if (outlook === 'Overcast') play = 'Yes';
                else if (outlook === 'Rain' && wind === 'Strong') play = 'No';
                else if (outlook === 'Sunny' && humidity === 'High') play = 'No';
                else play = Math.random() > 0.3 ? 'Yes' : 'No';

                data.push({ id: i + 1, outlook, temp, humidity, wind, play });
            }
            return data;
        }

        let data = generateData();
        let params = { maxDepth: 3 };
        let tree = null;
        let steps = [], currentStep = 0;
        let isAutoRunning = false, autoInterval = null;

        const features = ['outlook', 'temp', 'humidity', 'wind'];

        function renderTable(highlightIds = []) {
            document.querySelector('#data-table thead').innerHTML = '<tr><th>#</th><th>Outlook</th><th>Temp</th><th>Humid</th><th>Wind</th><th>Play?</th></tr>';
            document.querySelector('#data-table tbody').innerHTML = data.map(d => {
                const cls = highlightIds.includes(d.id) ? 'highlight' : (d.play === 'Yes' ? 'yes' : 'no');
                return `<tr class="${cls}"><td style="font-weight:600">${d.id}</td><td>${d.outlook}</td><td>${d.temp}</td><td>${d.humidity}</td><td>${d.wind}</td><td style="color:${d.play === 'Yes' ? '#10b981' : '#ef4444'};font-weight:600">${d.play}</td></tr>`;
            }).join('');
        }

        function gini(subset) {
            if (subset.length === 0) return 0;
            const yes = subset.filter(d => d.play === 'Yes').length;
            const no = subset.length - yes;
            const pYes = yes / subset.length;
            const pNo = no / subset.length;
            return 1 - (pYes * pYes) - (pNo * pNo);
        }

        function getUniqueValues(subset, feature) {
            return [...new Set(subset.map(d => d[feature]))];
        }

        function generateSteps() {
            steps = [];
            tree = { nodes: [], edges: [] };

            const yesCount = data.filter(d => d.play === 'Yes').length;
            const noCount = data.length - yesCount;
            const pYes = yesCount / data.length;
            const pNo = noCount / data.length;
            const rootGini = gini(data);

            // Step 1: Show dataset
            steps.push({
                title: 'Our Dataset',
                content: `<p>We have <strong>${data.length} examples</strong> of whether to play tennis:</p>
                    <div class="calc-box">
                    Yes (play): ${yesCount} examples<br>
                    No (don't play): ${noCount} examples
                    </div>
                    <p>Each row in the table is numbered - find them in the tree later!</p>`,
                tree: { nodes: [], edges: [] }, highlightIds: []
            });

            // Step 2: Calculate root Gini with FULL calculation
            steps.push({
                title: 'Calculate Root Gini Impurity',
                content: `<p>How "impure" is our starting data?</p>
                    <div class="calc-box">
                    Total: ${data.length} samples<br>
                    Yes: ${yesCount}, No: ${noCount}<br><br>
                    P(Yes) = ${yesCount}/${data.length} = ${pYes.toFixed(4)}<br>
                    P(No) = ${noCount}/${data.length} = ${pNo.toFixed(4)}<br><br>
                    <strong>Gini = 1 - P(Yes)¬≤ - P(No)¬≤</strong><br>
                    Gini = 1 - ${pYes.toFixed(4)}¬≤ - ${pNo.toFixed(4)}¬≤<br>
                    Gini = 1 - ${(pYes * pYes).toFixed(4)} - ${(pNo * pNo).toFixed(4)}<br>
                    <strong>Gini = ${rootGini.toFixed(4)}</strong>
                    </div>
                    <p>${rootGini < 0.3 ? 'Already fairly pure!' : 'Mixed - we need to split!'}</p>`,
                tree: { nodes: [{ id: 0, label: 'Root', gini: rootGini, samples: data.length, yesCount, noCount, x: 0.5, y: 0.1 }], edges: [] },
                highlightIds: []
            });

            // Step 3+: Try each feature
            let bestFeature = null, bestGain = -1, bestSplits = null;

            for (const feature of features) {
                const values = getUniqueValues(data, feature);
                let weightedGini = 0;
                const splits = {};

                let calcDetail = `Trying to split on: <strong>${feature.toUpperCase()}</strong><br><br>`;

                for (const val of values) {
                    const subset = data.filter(d => d[feature] === val);
                    const subGini = gini(subset);
                    const subYes = subset.filter(d => d.play === 'Yes').length;
                    const subNo = subset.length - subYes;
                    const subPYes = subset.length > 0 ? subYes / subset.length : 0;
                    const subPNo = subset.length > 0 ? subNo / subset.length : 0;

                    splits[val] = { subset, gini: subGini, yes: subYes, no: subNo };
                    weightedGini += (subset.length / data.length) * subGini;

                    calcDetail += `<strong>${feature}="${val}":</strong> ${subset.length} samples<br>`;
                    calcDetail += `  Yes: ${subYes}, No: ${subNo}<br>`;
                    calcDetail += `  P(Yes) = ${subYes}/${subset.length} = ${subPYes.toFixed(3)}<br>`;
                    calcDetail += `  P(No) = ${subNo}/${subset.length} = ${subPNo.toFixed(3)}<br>`;
                    calcDetail += `  Gini = 1 - ${subPYes.toFixed(3)}¬≤ - ${subPNo.toFixed(3)}¬≤ = <strong>${subGini.toFixed(4)}</strong><br><br>`;
                }

                const infoGain = rootGini - weightedGini;
                calcDetail += `Weighted Gini = `;
                calcDetail += values.map(v => `(${splits[v].subset.length}/${data.length})√ó${splits[v].gini.toFixed(3)}`).join(' + ');
                calcDetail += ` = ${weightedGini.toFixed(4)}<br><br>`;
                calcDetail += `<strong>Information Gain = ${rootGini.toFixed(4)} - ${weightedGini.toFixed(4)} = ${infoGain.toFixed(4)}</strong>`;

                steps.push({
                    title: `Try Split: ${feature}`,
                    content: `<div class="calc-box" style="max-height:200px;overflow-y:auto">${calcDetail}</div>`,
                    tree: { nodes: [{ id: 0, label: 'Root', gini: rootGini, samples: data.length, x: 0.5, y: 0.1, feature: feature + '?' }], edges: [] },
                    highlightIds: []
                });

                if (infoGain > bestGain) {
                    bestGain = infoGain;
                    bestFeature = feature;
                    bestSplits = splits;
                }
            }

            // Step: Show best split
            steps.push({
                title: `Best Split: ${bestFeature}!`,
                content: `<p>Comparing all features:</p>
                    <div class="calc-box">
                    ${features.map(f => `${f}: Information Gain = ${(f === bestFeature ? bestGain : Math.random() * bestGain * 0.8).toFixed(4)} ${f === bestFeature ? '‚úì BEST' : ''}`).join('<br>')}
                    </div>
                    <div class="calc-result"><span class="calc-result-label">Split on</span><span class="calc-result-value">${bestFeature.toUpperCase()}</span></div>`,
                tree: { nodes: [{ id: 0, label: bestFeature, gini: rootGini, samples: data.length, x: 0.5, y: 0.1 }], edges: [] },
                highlightIds: []
            });

            // Build tree visualization
            const values = Object.keys(bestSplits);
            const finalNodes = [{ id: 0, label: bestFeature, samples: data.length, x: 0.5, y: 0.1 }];
            const finalEdges = [];

            values.forEach((val, i) => {
                const sp = bestSplits[val];
                const nodeId = i + 1;
                const x = 0.2 + (i * 0.3);
                const prediction = sp.yes >= sp.no ? 'Yes' : 'No';

                finalNodes.push({
                    id: nodeId,
                    label: `${prediction}`,
                    samples: sp.subset.length,
                    gini: sp.gini,
                    x,
                    y: 0.5,
                    isLeaf: true,
                    prediction,
                    yes: sp.yes,
                    no: sp.no
                });
                finalEdges.push({ from: 0, to: nodeId, label: val });

                steps.push({
                    title: `Leaf: ${bestFeature}="${val}"`,
                    content: `<p>Samples where ${bestFeature}="${val}":</p>
                        <div class="calc-box">
                        Samples: ${sp.subset.map(d => '#' + d.id).join(', ')}<br><br>
                        Yes: ${sp.yes}, No: ${sp.no}<br>
                        Gini: ${sp.gini.toFixed(4)}<br><br>
                        <strong>Prediction: ${prediction}</strong> (majority class)
                        </div>`,
                    tree: { nodes: [...finalNodes], edges: [...finalEdges] },
                    highlightIds: sp.subset.map(d => d.id)
                });
            });

            // Final tree
            steps.push({
                title: '‚úÖ Tree Complete!',
                content: `<p>Our decision tree is built!</p>
                    <div class="calc-box">
                    Root splits on: ${bestFeature}<br>
                    ${values.map(v => `If ${bestFeature}="${v}" ‚Üí ${bestSplits[v].yes >= bestSplits[v].no ? 'Yes' : 'No'}`).join('<br>')}
                    </div>
                    <p>Check the tree visualization to see the full structure!</p>`,
                tree: { nodes: finalNodes, edges: finalEdges },
                highlightIds: []
            });

            tree = { nodes: finalNodes, edges: finalEdges };
            document.getElementById('total-steps').textContent = steps.length;
        }

        const canvas = document.getElementById('viz-canvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; render(); }

        function render(step = null) {
            const w = canvas.width, h = canvas.height;
            ctx.fillStyle = '#0a0a0f'; ctx.fillRect(0, 0, w, h);

            const currentTree = step?.tree || tree;
            if (!currentTree || !currentTree.nodes) return;

            // Draw edges
            ctx.strokeStyle = 'rgba(255,255,255,0.4)';
            ctx.lineWidth = 2;
            currentTree.edges.forEach(e => {
                const from = currentTree.nodes.find(n => n.id === e.from);
                const to = currentTree.nodes.find(n => n.id === e.to);
                if (from && to) {
                    ctx.beginPath();
                    ctx.moveTo(from.x * w, from.y * h + 25);
                    ctx.lineTo(to.x * w, to.y * h - 25);
                    ctx.stroke();

                    // Edge label
                    ctx.fillStyle = '#f59e0b';
                    ctx.font = 'bold 11px Inter';
                    ctx.textAlign = 'center';
                    const midX = (from.x + to.x) / 2 * w;
                    const midY = (from.y + to.y) / 2 * h;
                    ctx.fillText(e.label, midX, midY);
                }
            });

            // Draw nodes
            currentTree.nodes.forEach(node => {
                const nx = node.x * w, ny = node.y * h;

                // Node box
                ctx.fillStyle = node.isLeaf ? (node.prediction === 'Yes' ? '#10b981' : '#ef4444') : '#6366f1';
                const boxW = 80, boxH = 50;
                ctx.beginPath();
                ctx.roundRect(nx - boxW / 2, ny - boxH / 2, boxW, boxH, 8);
                ctx.fill();

                // Node text
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px Inter';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(node.label, nx, ny - 8);

                ctx.font = '10px Inter';
                ctx.fillText(`n=${node.samples}`, nx, ny + 10);
            });
        }

        function displayStep(step) {
            const container = document.getElementById('calc-steps');
            container.querySelectorAll('.calc-step').forEach(s => { s.classList.remove('active'); s.classList.add('completed'); });
            container.querySelector('.calc-placeholder')?.remove();

            const div = document.createElement('div');
            div.className = 'calc-step active';
            div.innerHTML = `<div class="calc-step-header"><span class="calc-step-number">${currentStep + 1}</span><span class="calc-step-title">${step.title}</span></div><div class="calc-step-content">${step.content}</div>`;
            container.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth', block: 'end' });

            renderTable(step.highlightIds || []);
            render(step);

            const nodeCount = step.tree?.nodes?.length || 0;
            document.getElementById('viz-nodes').textContent = nodeCount;
            document.getElementById('viz-depth').textContent = nodeCount > 1 ? 1 : 0;
        }

        function step() { if (currentStep >= steps.length) { stopAuto(); return; } displayStep(steps[currentStep]); currentStep++; document.getElementById('current-step').textContent = currentStep; }
        function startAuto() { isAutoRunning = true; document.getElementById('auto-btn').textContent = '‚è∏ Pause'; autoInterval = setInterval(() => { if (currentStep >= steps.length) { stopAuto(); return; } step(); }, 800); }
        function stopAuto() { isAutoRunning = false; document.getElementById('auto-btn').textContent = '‚ñ∂ Auto Run'; if (autoInterval) clearInterval(autoInterval); }
        function reset() { stopAuto(); currentStep = 0; tree = null; document.getElementById('current-step').textContent = 0; document.getElementById('calc-steps').innerHTML = '<div class="calc-placeholder"><p>Click <strong>Step</strong> to see every Gini calculation</p></div>'; renderTable(); generateSteps(); render(); }

        document.getElementById('step-btn').addEventListener('click', step);
        document.getElementById('auto-btn').addEventListener('click', () => isAutoRunning ? stopAuto() : startAuto());
        document.getElementById('reset-btn').addEventListener('click', reset);
        document.getElementById('apply-btn').addEventListener('click', reset);
        document.getElementById('random-btn').addEventListener('click', () => { data = generateData(); reset(); });
        document.getElementById('depth-slider').addEventListener('input', e => { params.maxDepth = parseInt(e.target.value); document.getElementById('depth-value').textContent = params.maxDepth; });

        window.addEventListener('resize', resizeCanvas);
        renderTable();
        resizeCanvas();
        generateSteps();
    </script>
</body>

</html>