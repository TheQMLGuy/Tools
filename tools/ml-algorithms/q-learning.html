<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q-Learning - ML Visualizer</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../styles/shared.css">
    <style>
        .app-container {
            display: grid;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            overflow: hidden;
        }

        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
        }

        .app-title {
            font-size: 1.2rem;
            font-weight: 600;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-right {
            display: flex;
            gap: 8px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 280px 1fr 1.2fr 280px;
            gap: 12px;
            padding: 12px;
            overflow: hidden;
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .left-column .panel {
            flex: 1;
            min-height: 0;
        }

        .panel {
            display: flex;
            flex-direction: column;
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.2);
        }

        .panel-header h2 {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .panel-body {
            flex: 1;
            overflow: auto;
            padding: 10px;
        }

        .panel-footer {
            padding: 8px 12px;
            border-top: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.65rem;
        }

        .data-table th {
            background: var(--bg-secondary);
            padding: 4px;
            text-align: center;
            border-bottom: 2px solid var(--accent-primary);
        }

        .data-table td {
            padding: 3px 4px;
            border-bottom: 1px solid var(--border-color);
            font-family: var(--font-mono);
            text-align: center;
        }

        .calc-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .calc-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            color: var(--text-muted);
            text-align: center;
        }

        .calc-step {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px;
            animation: fadeIn 0.3s;
        }

        .calc-step.active {
            border-color: var(--accent-primary);
        }

        .calc-step.completed {
            opacity: 0.6;
        }

        .calc-step-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .calc-step-number {
            width: 20px;
            height: 20px;
            background: var(--accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 600;
            color: white;
        }

        .calc-step-title {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .calc-step-content {
            font-size: 0.65rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .calc-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            padding: 6px;
            margin: 4px 0;
            font-family: var(--font-mono);
            font-size: 0.55rem;
            overflow-x: auto;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .viz-panel .panel-body {
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-world {
            display: grid;
            gap: 3px;
        }

        .grid-cell {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 1.2rem;
            position: relative;
        }

        .grid-cell.empty {
            background: var(--bg-card);
        }

        .grid-cell.wall {
            background: #374151;
        }

        .grid-cell.goal {
            background: #10b981;
        }

        .grid-cell.agent {
            background: #6366f1;
        }

        .grid-cell .q-vals {
            position: absolute;
            font-size: 0.45rem;
            color: rgba(255, 255, 255, 0.6);
            font-family: var(--font-mono);
        }

        .grid-cell .q-vals.top {
            top: 2px;
        }

        .grid-cell .q-vals.bottom {
            bottom: 2px;
        }

        .grid-cell .q-vals.left {
            left: 2px;
        }

        .grid-cell .q-vals.right {
            right: 2px;
        }

        .viz-stats {
            display: flex;
            gap: 12px;
            justify-content: center;
            font-size: 0.65rem;
        }

        .param-section {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 8px;
        }

        .param-section:last-child {
            border-bottom: none;
        }

        .param-section-title {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .param-item {
            margin-bottom: 10px;
        }

        .param-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.7rem;
        }

        .param-name code {
            font-family: var(--font-mono);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.65rem;
        }

        .param-value {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--accent-primary);
        }

        .btn-block {
            width: 100%;
            margin-top: 4px;
        }

        .btn-fs {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .btn-fs:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            padding: 20px;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .fullscreen-header h2 {
            font-size: 1.1rem;
            color: #fff;
        }

        .fullscreen-content {
            flex: 1;
            overflow: auto;
            background: var(--bg-panel);
            border-radius: 8px;
            padding: 16px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <h1 class="app-title">üéÆ Q-Learning - Step by Step</h1>
            <div class="header-right">
                <button id="step-btn" class="btn btn-secondary">‚è≠ Step</button>
                <button id="auto-btn" class="btn btn-primary">‚ñ∂ Auto Run</button>
                <button id="reset-btn" class="btn btn-ghost">‚Üª Reset</button>
            </div>
        </header>
        <main class="main-content">
            <div class="left-column">
                <section class="panel">
                    <div class="panel-header">
                        <h2>üìä Q-Table</h2>
                        <button class="btn-fs" onclick="openFullscreen('qtable')">‚õ∂</button>
                    </div>
                    <div class="panel-body">
                        <table id="q-table" class="data-table">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
                <section class="panel">
                    <div class="panel-header">
                        <h2>üìà Episode History</h2>
                        <button class="btn-fs" onclick="openFullscreen('history')">‚õ∂</button>
                    </div>
                    <div class="panel-body">
                        <table id="history-table" class="data-table">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>
            <section class="panel">
                <div class="panel-header">
                    <h2>üìê Q-Update Calculations</h2>
                    <div style="display:flex;align-items:center;gap:6px">
                        <span style="font-size:0.65rem;color:var(--text-muted)"><span id="current-step">0</span>/<span
                                id="total-steps">0</span></span>
                        <button class="btn-fs" onclick="openFullscreen('calc')">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div id="calc-steps" class="calc-steps">
                        <div class="calc-placeholder">
                            <p>Click <strong>Step</strong></p>
                        </div>
                    </div>
                </div>
            </section>
            <section class="panel viz-panel">
                <div class="panel-header">
                    <h2>üé® Grid World</h2>
                </div>
                <div class="panel-body" id="grid-container"></div>
                <div class="panel-footer">
                    <div class="viz-stats">
                        <span>Episode: <strong id="viz-ep">0</strong></span>
                        <span>Steps: <strong id="viz-steps">0</strong></span>
                        <span>Reward: <strong id="viz-reward">0</strong></span>
                    </div>
                </div>
            </section>
            <section class="panel">
                <div class="panel-header">
                    <h2>‚öôÔ∏è Params</h2>
                </div>
                <div class="panel-body">
                    <div class="param-section">
                        <div class="param-item">
                            <div class="param-header"><span class="param-name"><code>Œ± (lr)</code></span><span
                                    class="param-value" id="lr-value">0.5</span></div>
                            <input type="range" id="lr-slider" class="slider" min="0.1" max="1" step="0.1" value="0.5"
                                style="width:100%">
                        </div>
                        <div class="param-item">
                            <div class="param-header"><span class="param-name"><code>Œ≥ (discount)</code></span><span
                                    class="param-value" id="gamma-value">0.9</span></div>
                            <input type="range" id="gamma-slider" class="slider" min="0.5" max="1" step="0.1"
                                value="0.9" style="width:100%">
                        </div>
                        <div class="param-item">
                            <div class="param-header"><span class="param-name"><code>episodes</code></span><span
                                    class="param-value" id="ep-value">5</span></div>
                            <input type="range" id="ep-slider" class="slider" min="3" max="10" step="1" value="5"
                                style="width:100%">
                        </div>
                    </div>
                    <div class="param-section">
                        <div class="param-section-title">Bellman Equation</div>
                        <div style="font-size:0.5rem;color:var(--text-muted)">Q(s,a) ‚Üê Q(s,a) + Œ±[r + Œ≥¬∑max(Q(s',a')) -
                            Q(s,a)]</div>
                    </div>
                </div>
                <div class="panel-footer">
                    <button id="reset-btn2" class="btn btn-primary btn-block">üé≤ Reset</button>
                </div>
            </section>
        </main>
    </div>
    <div id="fullscreen-overlay" class="fullscreen-overlay">
        <div class="fullscreen-header">
            <h2 id="fullscreen-title">Fullscreen</h2><button class="btn btn-ghost" onclick="closeFullscreen()">‚úï
                Close</button>
        </div>
        <div class="fullscreen-content" id="fullscreen-content"></div>
    </div>
    <script>
        const GRID_SIZE = 4;
        const GOAL = { r: 0, c: 3 };
        const ACTIONS = ['‚Üë', '‚Üì', '‚Üê', '‚Üí'];
        const DELTAS = [[-1, 0], [1, 0], [0, -1], [0, 1]];

        let params = { lr: 0.5, gamma: 0.9, episodes: 5 };
        let Q = {};
        let episodeHistory = [];
        let steps = [], currentStep = 0;
        let isAutoRunning = false, autoInterval = null;
        let agentPos = { r: 3, c: 0 };

        function stateKey(r, c) { return `${r},${c}`; }
        function initQ() { for (let r = 0; r < GRID_SIZE; r++) for (let c = 0; c < GRID_SIZE; c++) Q[stateKey(r, c)] = [0, 0, 0, 0]; }

        function renderQTable() {
            document.querySelector('#q-table thead').innerHTML = '<tr><th>State</th><th>‚Üë</th><th>‚Üì</th><th>‚Üê</th><th>‚Üí</th></tr>';
            const rows = [];
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const k = stateKey(r, c);
                    rows.push(`<tr><td>(${r},${c})</td>${Q[k].map(v => `<td>${v.toFixed(2)}</td>`).join('')}</tr>`);
                }
            }
            document.querySelector('#q-table tbody').innerHTML = rows.join('');
        }

        function renderHistoryTable() {
            document.querySelector('#history-table thead').innerHTML = '<tr><th>Ep</th><th>Steps</th><th>Reward</th></tr>';
            document.querySelector('#history-table tbody').innerHTML = episodeHistory.map(e =>
                `<tr><td>${e.episode}</td><td>${e.steps}</td><td>${e.reward.toFixed(1)}</td></tr>`
            ).join('');
        }

        function renderGrid() {
            const container = document.getElementById('grid-container');
            container.innerHTML = '';
            const grid = document.createElement('div');
            grid.className = 'grid-world';
            grid.style.gridTemplateColumns = `repeat(${GRID_SIZE}, 50px)`;

            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    if (r === GOAL.r && c === GOAL.c) { cell.classList.add('goal'); cell.textContent = 'üèÜ'; }
                    else if (r === agentPos.r && c === agentPos.c) { cell.classList.add('agent'); cell.textContent = 'ü§ñ'; }
                    else { cell.classList.add('empty'); }

                    // Q-values
                    const k = stateKey(r, c);
                    if (Q[k]) {
                        const qv = Q[k];
                        cell.innerHTML += `<span class="q-vals top">${qv[0].toFixed(1)}</span>`;
                        cell.innerHTML += `<span class="q-vals bottom">${qv[1].toFixed(1)}</span>`;
                        cell.innerHTML += `<span class="q-vals left">${qv[2].toFixed(1)}</span>`;
                        cell.innerHTML += `<span class="q-vals right">${qv[3].toFixed(1)}</span>`;
                    }
                    grid.appendChild(cell);
                }
            }
            container.appendChild(grid);
        }

        function generateSteps() {
            steps = []; initQ(); episodeHistory = []; agentPos = { r: 3, c: 0 };
            steps.push({ title: 'Initialize', content: `<div class="calc-box">Grid: ${GRID_SIZE}√ó${GRID_SIZE}\nGoal: (${GOAL.r}, ${GOAL.c})\nQ-table initialized to 0</div>`, Q: JSON.parse(JSON.stringify(Q)), agent: { ...agentPos } });

            for (let ep = 1; ep <= params.episodes; ep++) {
                agentPos = { r: 3, c: 0 };
                let totalReward = 0, stepCount = 0;

                while (!(agentPos.r === GOAL.r && agentPos.c === GOAL.c) && stepCount < 20) {
                    const s = stateKey(agentPos.r, agentPos.c);
                    const a = Math.random() < 0.3 ? Math.floor(Math.random() * 4) : Q[s].indexOf(Math.max(...Q[s]));
                    const nr = Math.max(0, Math.min(GRID_SIZE - 1, agentPos.r + DELTAS[a][0]));
                    const nc = Math.max(0, Math.min(GRID_SIZE - 1, agentPos.c + DELTAS[a][1]));
                    const ns = stateKey(nr, nc);
                    const r = (nr === GOAL.r && nc === GOAL.c) ? 10 : -0.1;

                    const oldQ = Q[s][a];
                    const maxNextQ = Math.max(...Q[ns]);
                    const newQ = oldQ + params.lr * (r + params.gamma * maxNextQ - oldQ);

                    let calcStr = `Episode ${ep}, Step ${stepCount + 1}\n\n`;
                    calcStr += `State: (${agentPos.r}, ${agentPos.c})\nAction: ${ACTIONS[a]}\n`;
                    calcStr += `Next State: (${nr}, ${nc})\nReward: ${r}\n\n`;
                    calcStr += `Q-Update:\nQ(s,a) = ${oldQ.toFixed(4)} + ${params.lr}√ó[${r} + ${params.gamma}√ó${maxNextQ.toFixed(4)} - ${oldQ.toFixed(4)}]\n`;
                    calcStr += `       = ${oldQ.toFixed(4)} + ${params.lr}√ó${(r + params.gamma * maxNextQ - oldQ).toFixed(4)}\n`;
                    calcStr += `       = ${newQ.toFixed(4)}`;

                    Q[s][a] = newQ;
                    agentPos = { r: nr, c: nc };
                    totalReward += r;
                    stepCount++;

                    steps.push({ title: `Ep ${ep} Step ${stepCount}`, content: `<div class="calc-box">${calcStr}</div>`, Q: JSON.parse(JSON.stringify(Q)), agent: { ...agentPos }, ep, stepCount, reward: totalReward });
                }

                episodeHistory.push({ episode: ep, steps: stepCount, reward: totalReward });
            }

            steps.push({ title: '‚úÖ Complete!', content: `<div class="calc-box">${params.episodes} episodes completed!\n\nOptimal policy learned.</div>`, Q: JSON.parse(JSON.stringify(Q)), agent: GOAL, ep: params.episodes });
            document.getElementById('total-steps').textContent = steps.length;
        }

        function openFullscreen(type) {
            const o = document.getElementById('fullscreen-overlay'), t = document.getElementById('fullscreen-title'), c = document.getElementById('fullscreen-content');
            o.classList.add('active');
            if (type === 'qtable') {
                t.textContent = 'üìä Q-Table';
                let rows = '';
                for (let r = 0; r < GRID_SIZE; r++) for (let c = 0; c < GRID_SIZE; c++) { const k = stateKey(r, c); rows += `<tr><td>(${r},${c})</td>${Q[k].map(v => `<td>${v.toFixed(6)}</td>`).join('')}</tr>`; }
                c.innerHTML = `<table class="data-table" style="font-size:0.9rem"><thead><tr><th>State</th><th>‚Üë</th><th>‚Üì</th><th>‚Üê</th><th>‚Üí</th></tr></thead><tbody>${rows}</tbody></table>`;
            } else if (type === 'history') {
                t.textContent = 'üìà Episode History';
                c.innerHTML = `<table class="data-table" style="font-size:0.9rem"><thead><tr><th>Episode</th><th>Steps</th><th>Total Reward</th></tr></thead><tbody>${episodeHistory.map(e => `<tr><td>${e.episode}</td><td>${e.steps}</td><td>${e.reward.toFixed(4)}</td></tr>`).join('')}</tbody></table>`;
            } else if (type === 'calc') { t.textContent = 'üìê All Steps'; c.innerHTML = document.getElementById('calc-steps').innerHTML; }
        }
        function closeFullscreen() { document.getElementById('fullscreen-overlay').classList.remove('active'); }
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeFullscreen(); });

        function displayStep(step) {
            const container = document.getElementById('calc-steps');
            container.querySelectorAll('.calc-step').forEach(s => { s.classList.remove('active'); s.classList.add('completed'); });
            container.querySelector('.calc-placeholder')?.remove();
            const div = document.createElement('div'); div.className = 'calc-step active';
            div.innerHTML = `<div class="calc-step-header"><span class="calc-step-number">${currentStep + 1}</span><span class="calc-step-title">${step.title}</span></div><div class="calc-step-content">${step.content}</div>`;
            container.appendChild(div); div.scrollIntoView({ behavior: 'smooth', block: 'end' });
            Q = step.Q; agentPos = step.agent;
            renderQTable(); renderHistoryTable(); renderGrid();
            document.getElementById('viz-ep').textContent = step.ep || 0;
            document.getElementById('viz-steps').textContent = step.stepCount || 0;
            document.getElementById('viz-reward').textContent = step.reward?.toFixed(1) || 0;
        }

        function step() { if (currentStep >= steps.length) { stopAuto(); return; } displayStep(steps[currentStep]); currentStep++; document.getElementById('current-step').textContent = currentStep; }
        function startAuto() { isAutoRunning = true; document.getElementById('auto-btn').textContent = '‚è∏ Pause'; autoInterval = setInterval(() => { if (currentStep >= steps.length) { stopAuto(); return; } step(); }, 400); }
        function stopAuto() { isAutoRunning = false; document.getElementById('auto-btn').textContent = '‚ñ∂ Auto Run'; if (autoInterval) clearInterval(autoInterval); }
        function reset() { stopAuto(); currentStep = 0; initQ(); episodeHistory = []; agentPos = { r: 3, c: 0 }; document.getElementById('current-step').textContent = 0; document.getElementById('calc-steps').innerHTML = '<div class="calc-placeholder"><p>Click <strong>Step</strong></p></div>'; generateSteps(); renderQTable(); renderHistoryTable(); renderGrid(); }

        document.getElementById('step-btn').addEventListener('click', step);
        document.getElementById('auto-btn').addEventListener('click', () => isAutoRunning ? stopAuto() : startAuto());
        document.getElementById('reset-btn').addEventListener('click', reset);
        document.getElementById('reset-btn2').addEventListener('click', reset);
        document.getElementById('lr-slider').addEventListener('input', e => { params.lr = parseFloat(e.target.value); document.getElementById('lr-value').textContent = params.lr; });
        document.getElementById('gamma-slider').addEventListener('input', e => { params.gamma = parseFloat(e.target.value); document.getElementById('gamma-value').textContent = params.gamma; });
        document.getElementById('ep-slider').addEventListener('input', e => { params.episodes = parseInt(e.target.value); document.getElementById('ep-value').textContent = params.episodes; });

        initQ(); renderQTable(); renderHistoryTable(); renderGrid(); generateSteps();
    </script>
</body>

</html>